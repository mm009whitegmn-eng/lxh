<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–µå±‹å¤§å†’é™©ï¼šå¹ºå¹ºä¸çŸ³æ¦´</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- æ•´ä½“é£æ ¼ï¼šç¥ç§˜é—è¿¹ --- */
        body { margin: 0; overflow: hidden; background-color: #2c3e50; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; }
        
        /* èœå•å±‚ */
        #menu-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 200;
            color: white;
        }
        
        .menu-box {
            background: #34495e; padding: 40px; border-radius: 20px; border: 4px solid #f1c40f;
            text-align: center; max-width: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        button {
            background: #e67e22; color: white; border: none; padding: 15px 30px;
            font-size: 18px; border-radius: 50px; cursor: pointer; margin: 10px;
            font-weight: bold; transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        button.secondary { background: #16a085; }
        
        input { padding: 15px; border-radius: 10px; border: none; width: 200px; text-align: center; font-size: 18px; }

        /* æ¸¸æˆç•Œé¢ UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        /* èŠå¤©æ¡† */
        #chat-container {
            position: absolute; bottom: 80px; left: 20px; width: 300px; height: 150px;
            pointer-events: auto; display: flex; flex-direction: column;
        }
        #chat-history {
            flex: 1; background: rgba(0,0,0,0.5); color: white; overflow-y: auto;
            padding: 10px; border-radius: 10px 10px 0 0; font-size: 14px;
        }
        #chat-input-area { display: flex; }
        #chat-input { flex: 1; padding: 10px; border: none; border-radius: 0 0 0 10px; }
        #chat-send { width: 60px; border: none; background: #2ecc71; color: white; cursor: pointer; border-radius: 0 0 10px 0; }

        /* çŠ¶æ€æ  */
        .hud-bar {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255,255,255,0.9); padding: 10px 20px;
            border-radius: 30px; font-weight: bold; color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; gap: 20px;
        }

        /* å­˜æ¡£æç¤º */
        #save-notify {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
            background: #27ae60; color: white; padding: 10px 20px; border-radius: 20px;
            opacity: 0; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="save-notify">ğŸ’¾ è¿›åº¦å·²ä¿å­˜ï¼</div>

<div id="menu-layer">
    <div class="menu-box" id="step-role">
        <h1 style="color:#f1c40f;">ğŸ± å–µå±‹å¤§å†’é™© ğŸ¶</h1>
        <p>è¯·é€‰æ‹©ä½ çš„èº«ä»½ï¼š</p>
        <button onclick="selectRole('A')">æˆ‘æ˜¯ ææ™“æ™— (å¹ºå¹º/é»„çŒ«)</button>
        <br>
        <button class="secondary" onclick="selectRole('B')">æˆ‘æ˜¯ ç‹å­è·¯ (çŸ³æ¦´/ç™½çŒ«)</button>
    </div>

    <div class="menu-box" id="step-conn" style="display:none;">
        <h2 id="role-title"></h2>
        <div id="host-panel" style="display:none;">
            <p>æˆ¿ä¸» ID (å‘ç»™å¯¹æ–¹):</p>
            <h1 id="my-id" style="color:#f1c40f; letter-spacing: 3px;">...</h1>
            <p class="loading">ç­‰å¾…ä¼´ä¾£è¿æ¥...</p>
        </div>
        <div id="join-panel" style="display:none;">
            <p>è¾“å…¥å¯¹æ–¹çš„ ID:</p>
            <input type="text" id="target-id" placeholder="ä¾‹å¦‚: X7Z2">
            <br><br>
            <button onclick="connectToPartner()">è¿æ¥å¹¶å¼€å§‹</button>
        </div>
        <br>
        <button onclick="loadGameLocal()" style="font-size:14px; background:#7f8c8d;">è¯»å–æœ¬åœ°å­˜æ¡£</button>
    </div>
</div>

<div id="ui-layer">
    <div class="hud-bar">
        <span>ğŸ’› å¹ºå¹º: <span id="hp-a">100</span>%</span>
        <span>ğŸ¤ çŸ³æ¦´: <span id="hp-b">100</span>%</span>
        <span>ğŸ”‘ é’¥åŒ™: <span id="key-count">0</span>/3</span>
        <span>ğŸš© å…³å¡: <span id="level-num">1</span></span>
    </div>

    <div style="position:absolute; right:20px; top:20px;">
        <button style="padding:10px; font-size:14px; background:#9b59b6;" onclick="saveGame()">ğŸ’¾ ä¿å­˜</button>
    </div>

    <div id="chat-container">
        <div id="chat-history"></div>
        <div id="chat-input-area">
            <input id="chat-input" placeholder="æŒ‰å›è½¦å‘é€..." onkeypress="if(event.keyCode===13) sendChat()">
            <button id="chat-send" onclick="sendChat()">å‘é€</button>
        </div>
    </div>
</div>

<script>
// --- å…¨å±€å˜é‡ä¸é…ç½® ---
const CFG = {
    roles: {
        'A': { name: 'ææ™“æ™—', pet: 'å¹ºå¹º', color: '#f1c40f', skin: 'ğŸ±' }, // é»„çŒ«
        'B': { name: 'ç‹å­è·¯', pet: 'çŸ³æ¦´', color: '#ecf0f1', skin: 'ğŸ˜º' }  // ç™½çŒ«
    }
};

let myRole = 'A'; // é»˜è®¤
let peer = null, conn = null;
let gameRunning = false;
let currentLevel = 1;

// æ¸¸æˆå®ä½“
const player = { x: 300, y: 300, hp: 100, role: 'A' };
const partner = { x: 300, y: 300, hp: 100, role: 'B', active: false };
const keys = []; // å…³å¡ä¸­çš„é’¥åŒ™
const ghosts = []; // æ•Œäºº
const exitDoor = { x: 0, y: 0, open: false };
let collectedKeys = 0;

// --- 1. èœå•ä¸è¿æ¥é€»è¾‘ ---

function selectRole(role) {
    myRole = role;
    player.role = role;
    partner.role = (role === 'A') ? 'B' : 'A'; // å¯¹æ–¹æ˜¯å¦ä¸€ä¸ª
    
    document.getElementById('step-role').style.display = 'none';
    document.getElementById('step-conn').style.display = 'block';
    
    const info = CFG.roles[role];
    document.getElementById('role-title').innerText = `ä½ å¥½ï¼Œ${info.name} (${info.pet})`;
    
    // åˆå§‹åŒ– Peer
    initPeer();
}

function initPeer() {
    // å¦‚æœæ˜¯ A (å¹ºå¹º)ï¼Œé»˜è®¤ä½œä¸ºæˆ¿ä¸»ï¼›å¦‚æœæ˜¯ B (çŸ³æ¦´)ï¼Œé»˜è®¤ä½œä¸ºåŠ å…¥è€…
    // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è¿˜æ˜¯è®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ IDï¼Œè¿™æ ·æ›´ç¨³å®š
    const isHost = (myRole === 'A'); 
    
    if(isHost) {
        document.getElementById('host-panel').style.display = 'block';
        const id = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(id);
        peer.on('open', (id) => { document.getElementById('my-id').innerText = id; });
        peer.on('connection', (c) => {
            conn = c;
            setupConnection();
        });
    } else {
        document.getElementById('join-panel').style.display = 'block';
        peer = new Peer(); // è‡ªåŠ¨ID
    }
}

function connectToPartner() {
    const target = document.getElementById('target-id').value.toUpperCase();
    if(!target) return alert("è¯·è¾“å…¥ID");
    conn = peer.connect(target);
    setupConnection();
}

function setupConnection() {
    conn.on('open', () => {
        console.log("è¿æ¥å»ºç«‹ï¼");
        startGame();
        // å‘é€ä¸€æ¬¡é—®å€™
        conn.send({ type: 'chat', name: 'ç³»ç»Ÿ', msg: 'ä¼´ä¾£å·²è¿æ¥ï¼ä¸€èµ·å»å†’é™©å§ï¼' });
    });
    conn.on('data', handleData);
    conn.on('close', () => alert("è¿æ¥æ–­å¼€"));
}

function handleData(data) {
    if (data.type === 'move') {
        partner.x = data.x;
        partner.y = data.y;
        partner.hp = data.hp;
        partner.active = true;
    } else if (data.type === 'chat') {
        addMessage(data.name, data.msg, false);
    } else if (data.type === 'syncLevel') {
        // åŒæ­¥å…³å¡è¿›åº¦
        if(data.level > currentLevel) loadLevel(data.level);
    }
}

// --- 2. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W, H;

function resize() { W = window.innerWidth; H = window.innerHeight; canvas.width = W; canvas.height = H; }
window.addEventListener('resize', resize);
resize();

// è¾“å…¥æ§åˆ¶
const keysPressed = {};
window.addEventListener('keydown', e => keysPressed[e.key] = true);
window.addEventListener('keyup', e => keysPressed[e.key] = false);

// è§¦æ‘¸æ§åˆ¶ (ç®€å•çš„ç‚¹å‡»ç§»åŠ¨)
let touchTarget = null;
window.addEventListener('touchstart', e => {
    touchTarget = { x: e.touches[0].clientX, y: e.touches[0].clientY };
});
window.addEventListener('touchend', () => touchTarget = null);

function startGame() {
    document.getElementById('menu-layer').style.display = 'none';
    document.getElementById('ui-layer').style.display = 'block';
    gameRunning = true;
    loadLevel(currentLevel);
    loop();
}

function loadLevel(lv) {
    currentLevel = lv;
    document.getElementById('level-num').innerText = lv;
    collectedKeys = 0;
    
    // ç”Ÿæˆåœ°å›¾ (ç®€å•çš„éšæœºç”Ÿæˆ)
    keys.length = 0;
    ghosts.length = 0;
    
    // 3æŠŠé’¥åŒ™
    for(let i=0; i<3; i++) {
        keys.push({ x: Math.random() * (W-100) + 50, y: Math.random() * (H-100) + 50, collected: false });
    }
    
    // å¹½çµ (éšå…³å¡å¢åŠ )
    for(let i=0; i< lv + 1; i++) {
        ghosts.push({ 
            x: Math.random() * W, y: Math.random() * H, 
            vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3 
        });
    }

    // å‡ºå£
    exitDoor.x = W - 100;
    exitDoor.y = H - 100;
    
    // é‡ç½®ä½ç½®
    player.x = 100; player.y = 100;
    
    addMessage("ç³»ç»Ÿ", `ç¬¬ ${lv} å…³å¼€å§‹ï¼æ”¶é›† 3 æŠŠé’¥åŒ™æ‰“å¼€å¤§é—¨ï¼`, true);
}

function update() {
    // 1. ç©å®¶ç§»åŠ¨
    const speed = 4;
    if (keysPressed['w']) player.y -= speed;
    if (keysPressed['s']) player.y += speed;
    if (keysPressed['a']) player.x -= speed;
    if (keysPressed['d']) player.x += speed;
    
    if(touchTarget) {
        const dx = touchTarget.x - player.x;
        const dy = touchTarget.y - player.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist > 5) {
            player.x += (dx/dist) * speed;
            player.y += (dy/dist) * speed;
        }
    }

    // è¾¹ç•Œæ£€æŸ¥
    if(player.x < 0) player.x = 0; if(player.x > W) player.x = W;
    if(player.y < 0) player.y = 0; if(player.y > H) player.y = H;

    // 2. é’¥åŒ™æ”¶é›†
    keys.forEach(k => {
        if(!k.collected && Math.hypot(player.x - k.x, player.y - k.y) < 30) {
            k.collected = true;
            collectedKeys++;
            addMessage("ç³»ç»Ÿ", "ä½ æ‰¾åˆ°äº†ä¸€æŠŠé’¥åŒ™ï¼", true);
            // ç®€å•åŒæ­¥ï¼šå¦‚æœæˆ‘åƒäº†ï¼Œå‘Šè¯‰å¯¹æ–¹ (è¿™é‡Œç®€åŒ–ä¸ºå„è‡ªåƒå„è‡ªçš„é€»è¾‘ï¼Œå®é™…åº”è¯¥åŒæ­¥ID)
        }
    });

    // 3. å¹½çµé€»è¾‘ (ç®€å•çš„å·¡é€» + ç¢°æ’)
    ghosts.forEach(g => {
        g.x += g.vx; g.y += g.vy;
        if(g.x < 0 || g.x > W) g.vx *= -1;
        if(g.y < 0 || g.y > H) g.vy *= -1;
        
        // ç¢°æ’æ£€æµ‹
        if(Math.hypot(player.x - g.x, player.y - g.y) < 30) {
            player.hp -= 1;
            // éœ‡åŠ¨æ•ˆæœ
            if(navigator.vibrate) navigator.vibrate(50);
        }
    });

    // 4. é€šå…³åˆ¤å®š
    // å‡è®¾ä¸¤äººå…±äº«è¿›åº¦ï¼Œè¿™é‡Œç®€åŒ–ä¸ºæœ¬åœ°åˆ¤å®šï¼šå¦‚æœé’¥åŒ™å¤Ÿäº†ï¼Œèµ°åˆ°é—¨
    // åœ¨çœŸå®å¤šäººé‡Œï¼Œåº”è¯¥åŒæ­¥ keys çŠ¶æ€ã€‚è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œåªè¦æˆ‘åœ¨æœ¬åœ°åƒåˆ°3ä¸ªå°±ç®—å¼€é—¨ã€‚
    if(collectedKeys >= 3) {
        exitDoor.open = true;
        if(Math.hypot(player.x - exitDoor.x, player.y - exitDoor.y) < 50) {
            currentLevel++;
            loadLevel(currentLevel);
            // é€šçŸ¥å¯¹æ–¹è¿›å…¥ä¸‹ä¸€å…³
            if(conn && conn.open) conn.send({ type: 'syncLevel', level: currentLevel });
        }
    }

    // 5. æ•°æ®åŒæ­¥å‘é€
    if (conn && conn.open) {
        conn.send({
            type: 'move',
            x: player.x,
            y: player.y,
            hp: player.hp
        });
    }
    
    // UI æ›´æ–°
    const myRoleData = CFG.roles[player.role];
    const partnerRoleData = CFG.roles[partner.role];
    
    document.getElementById(myRole === 'A' ? 'hp-a' : 'hp-b').innerText = Math.floor(player.hp);
    document.getElementById(partner.role === 'A' ? 'hp-a' : 'hp-b').innerText = partner.active ? Math.floor(partner.hp) : 'ç¦»çº¿';
    document.getElementById('key-count').innerText = collectedKeys;
    
    if(player.hp <= 0) {
        alert("ä½ æ™•å€’äº†... å¹ºå¹º/çŸ³æ¦´ ä¼šæŠŠä½ æ•‘å›èµ·ç‚¹çš„ï¼");
        player.hp = 100;
        player.x = 100; player.y = 100;
    }
}

function draw() {
    // èƒŒæ™¯ï¼šæ·±è‰²åœ°ç‰¢
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(0, 0, W, H);
    
    // ç»˜åˆ¶ç½‘æ ¼åœ°æ¿
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.beginPath();
    for(let x=0; x<W; x+=40) { ctx.moveTo(x,0); ctx.lineTo(x,H); }
    for(let y=0; y<H; y+=40) { ctx.moveTo(0,y); ctx.lineTo(W,y); }
    ctx.stroke();

    // ç»˜åˆ¶å¤§é—¨
    ctx.fillStyle = exitDoor.open ? '#2ecc71' : '#e74c3c';
    ctx.fillRect(exitDoor.x - 30, exitDoor.y - 30, 60, 60);
    ctx.fillStyle = '#fff';
    ctx.font = '20px Arial';
    ctx.fillText(exitDoor.open ? "å…¥å£" : "é”ä½", exitDoor.x-20, exitDoor.y);

    // ç»˜åˆ¶é’¥åŒ™
    ctx.font = '30px Arial';
    keys.forEach(k => {
        if(!k.collected) ctx.fillText('ğŸ”‘', k.x-15, k.y+10);
    });

    // ç»˜åˆ¶å¹½çµ (æƒŠé™©å…ƒç´ )
    ctx.font = '30px Arial';
    ghosts.forEach(g => {
        ctx.fillText('ğŸ‘»', g.x-15, g.y+10);
        // å¹½çµå…‰ç¯
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255,0,0,0.3)';
        ctx.arc(g.x, g.y, 40, 0, Math.PI*2);
        ctx.stroke();
    });

    // ç»˜åˆ¶é˜Ÿå‹
    if (partner.active) {
        drawCat(partner.x, partner.y, partner.role, false);
    }

    // ç»˜åˆ¶è‡ªå·±
    drawCat(player.x, player.y, player.role, true);
}

function drawCat(x, y, role, isSelf) {
    const info = CFG.roles[role];
    
    // åå­—
    ctx.fillStyle = '#fff';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(info.name + (isSelf?"(æˆ‘)":""), x, y - 35);
    
    // å® ç‰©åå­—
    ctx.fillStyle = info.color;
    ctx.font = '10px Arial';
    ctx.fillText(info.pet, x, y - 22);

    // çŒ«å’ªæœ¬ä½“ (ç”¨ Emoji ç»˜åˆ¶ï¼Œæ–¹ä¾¿ä¸”é«˜æ¸…)
    ctx.font = '40px Arial';
    // å¹ºå¹º(A)æ˜¾ç¤ºé»„è„¸çŒ«ï¼ŒçŸ³æ¦´(B)æ˜¾ç¤ºç™½è„¸çŒ«
    ctx.fillText(info.skin, x, y + 10);
    
    // è¡€æ¡
    if(isSelf) {
        ctx.fillStyle = '#c0392b';
        ctx.fillRect(x - 20, y + 20, 40, 5);
        ctx.fillStyle = '#2ecc71';
        ctx.fillRect(x - 20, y + 20, 40 * (player.hp/100), 5);
    }
}

function loop() {
    if (!gameRunning) return;
    update();
    draw();
    requestAnimationFrame(loop);
}

// --- 3. èŠå¤©ä¸å­˜æ¡£ç³»ç»Ÿ ---

function sendChat() {
    const input = document.getElementById('chat-input');
    const msg = input.value;
    if (!msg) return;
    
    const name = CFG.roles[player.role].name;
    // å‘ç»™è‡ªå·±
    addMessage(name, msg, true);
    // å‘ç»™å¯¹æ–¹
    if (conn && conn.open) {
        conn.send({ type: 'chat', name: name, msg: msg });
    }
    input.value = '';
}

function addMessage(name, msg, isMe) {
    const div = document.createElement('div');
    div.style.marginBottom = '5px';
    div.style.color = isMe ? '#f1c40f' : '#ecf0f1';
    div.innerHTML = `<strong>${name}:</strong> ${msg}`;
    
    const history = document.getElementById('chat-history');
    history.appendChild(div);
    history.scrollTop = history.scrollHeight;
}

// å­˜æ¡£ç³»ç»Ÿ (LocalStorage)
function saveGame() {
    const data = {
        level: currentLevel,
        role: player.role,
        hp: player.hp
    };
    localStorage.setItem('cat_adventure_save', JSON.stringify(data));
    
    const notify = document.getElementById('save-notify');
    notify.style.opacity = 1;
    setTimeout(() => notify.style.opacity = 0, 2000);
}

function loadGameLocal() {
    const json = localStorage.getItem('cat_adventure_save');
    if(!json) return alert("è¿˜æ²¡æœ‰å­˜æ¡£å“¦ï¼");
    
    const data = JSON.parse(json);
    currentLevel = data.level;
    player.hp = data.hp;
    // è§’è‰²é€šå¸¸ç”±é‡æ–°é€‰æ‹©å†³å®šï¼Œè¿™é‡Œä»…è¯»å–è¿›åº¦
    alert(`è¯»å–æˆåŠŸï¼å³å°†è¿›å…¥ç¬¬ ${data.level} å…³`);
    // éœ€è¦é‡æ–°è¿æ¥æ‰èƒ½ç©ï¼Œæ‰€ä»¥åªæ›´æ–°å˜é‡
}

</script>
</body>
</html>
